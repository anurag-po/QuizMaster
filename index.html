<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - by Anurag</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .option-row input[type="radio"] {
            width: auto; 
            margin: 0;
        }
        
        :root { --primary: #4F46E5; 
            --bg: #f3f4f6; 
            --surface: #ffffff; 
            --text: #1f2937; 
            --danger: #ef4444; 
            --success: #10b981; }
            
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; }
        .container { 
            max-width: 800px; 
            margin: 0 auto; }
        .hidden { 
            display: none !important; }
        .card { 
            background: var(--surface); 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            margin-bottom: 20px; }
        .btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px; }
        .btn-outline { 
            background: transparent; 
            border: 2px solid var(--primary); 
            color: var(--primary); }
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            box-sizing: border-box; 
            margin-bottom: 10px; }
        .option-btn { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 2px solid #eee; 
            background: white; 
            cursor: pointer; 
            border-radius: 8px; 
            text-align: left; }
        .option-btn.correct { 
            background: #d1fae5; 
            border-color: var(--success); }
        .option-btn.wrong { 
            background: #fee2e2; 
            border-color: var(--danger); }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary); 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <script>
        /* Supabase details */
        const SUPABASE_URL = 'https://eegnrljorqkpnfwfwhdo.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_EkTK3j-tJJslpyu2KibQBw_yM7_vEQd'; 
        
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <div class="container">
        <div id="loading" class="loader"></div>

        <div id="view-login" class="card hidden" style="text-align: center;">
            <h1 style="color: var(--primary);">QuizMaster</h1>
            <p>Login to create and save quizzes.</p>
            <button onclick="app.loginGoogle()" class="btn" style="background: white; color: #444; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.706a5.41 5.41 0 0 1 0-3.412V4.962H.957a9.003 9.003 0 0 0 0 7.922l3.007-2.178z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.962l3.007 2.178C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>

        <div id="view-dashboard" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="user-greeting">Hello!</h2>
                <button onclick="app.logout()" class="btn btn-outline" style="width: auto; padding: 5px 15px;">Logout</button>
            </div>
            <button onclick="app.showCreate()" class="btn" style="margin-bottom: 20px;">+ Create New Quiz</button>
            <div id="quiz-list"></div>
        </div>

        <div id="view-create" class="hidden">
            <button onclick="app.loadDashboard()" class="btn btn-outline" style="width: auto;">&larr; Back</button>
            <div class="card">
                <h2>Create Quiz</h2>
                <input id="new-title" placeholder="Quiz Title">
                <textarea id="new-desc" placeholder="Description"></textarea>
                <div id="create-questions-area"></div>
                <button onclick="creator.addQuestionUI()" class="btn btn-outline">+ Add Question</button>
                <button onclick="creator.publish()" class="btn">Publish Quiz</button>
            </div>
        </div>

        <div id="view-take" class="hidden">
            <button onclick="app.loadDashboard()" class="btn btn-outline" style="width: auto;">Cancel</button>
            <div class="card">
                <h2 id="take-title">Title</h2>
                <div id="take-area"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

  
const app = {
    init: async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            currentUser = session.user;
            app.loadDashboard();
        } else {
            app.toggleView('view-login');
        }
        document.getElementById('loading').classList.add('hidden');
    },

    toggleView: (viewId) => {
        ['view-login', 'view-dashboard', 'view-create', 'view-take'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
    },

    loginGoogle: async () => {
        await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.href }
        });
    },

    logout: async () => {
        await supabase.auth.signOut();
        window.location.reload();
    },

    loadDashboard: async () => {
        app.toggleView('view-dashboard');
        document.getElementById('user-greeting').innerText = `Hello, ${currentUser.user_metadata.full_name || 'User'}`;
        
        const { data: quizzes, error } = await supabase
            .from('quizzes')
            .select('*')
            .order('created_at', { ascending: false });

        const list = document.getElementById('quiz-list');
        list.innerHTML = '';
        
        if (quizzes) {
            quizzes.forEach(q => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.position = 'relative';

                let adminControls = '';
                if (currentUser && currentUser.id === q.creator_id) {
                    adminControls = `
                        <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: flex; gap: 10px;">
                            <button onclick="event.stopPropagation(); creator.editStart('${q.id}')" class="btn btn-outline" style="font-size: 0.8rem; padding: 5px 10px; margin:0;">Edit</button>
                            <button onclick="event.stopPropagation(); app.deleteQuiz('${q.id}')" class="btn" style="background: var(--danger); font-size: 0.8rem; padding: 5px 10px; margin:0;">Delete</button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <h3>${q.title}</h3>
                    <p>${q.description || ''}</p>
                    <div style="font-size:0.8rem; color:#888">By ${q.author_name || 'Unknown'}</div>
                    ${adminControls}
                `;
                
              
                div.onclick = (e) => {
                 
                    taker.start(q.id, q.title);
                };
                div.style.cursor = 'pointer';
                list.appendChild(div);
            });
        }
    },

    showCreate: () => {
        creator.editingQuizId = null; 
        app.toggleView('view-create');
        creator.reset();
    },

    deleteQuiz: async (quizId) => {
        if(!confirm("Are you sure? This will delete the quiz and all questions.")) return;

        const { error } = await supabase.from('quizzes').delete().eq('id', quizId);
        
        if (error) alert("Error deleting: " + error.message);
        else {
            alert("Quiz deleted.");
            app.loadDashboard();
        }
    }
};



   
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

const creator = {
    questions: [],
    editingQuizId: null, 
    
    reset: () => {
        document.getElementById('new-title').value = '';
        document.getElementById('new-desc').value = '';
        document.getElementById('create-questions-area').innerHTML = '';
        creator.questions = [];
        creator.addQuestionUI();
    },

 
    editStart: async (quizId) => {
        creator.editingQuizId = quizId;
        app.toggleView('view-create');
        

        const { data: quiz } = await supabase.from('quizzes').select('*').eq('id', quizId).single();
        document.getElementById('new-title').value = quiz.title;
        document.getElementById('new-desc').value = quiz.description;

   
        const { data: questions } = await supabase.from('questions').select('*').eq('quiz_id', quizId).order('id');
        
      
        document.getElementById('create-questions-area').innerHTML = '';
        creator.questions = [];

        questions.forEach((q, index) => {
         
            creator.addQuestionUI(); 
            
          
            const block = document.getElementById('create-questions-area').lastChild;
            block.querySelector('.q-input').value = q.question_text;
            const optionInputs = block.querySelectorAll('.o-input');
            q.options.forEach((optText, i) => {
                if(optionInputs[i]) optionInputs[i].value = optText;
            });
       
            const radios = block.querySelectorAll('input[type="radio"]');
            if(radios[q.correct_index]) radios[q.correct_index].checked = true;
        });
    },

    addQuestionUI: () => {
        
        const id = creator.questions.length;
        const container = document.getElementById('create-questions-area');
        const div = document.createElement('div');
        div.style.borderTop = "1px solid #eee";
        div.style.paddingTop = "15px";
        div.style.marginTop = "15px";
        
        div.innerHTML = `
            <p><strong>Question ${id+1}</strong> <span style="font-size:0.8rem; color:#666;">(Select correct answer)</span></p>
            <input class="q-input" placeholder="Enter Question Text Here" style="font-weight:bold;">
            <div class="option-row"><input type="radio" name="q_${id}_correct" value="0" checked><input class="o-input" placeholder="Option 1"></div>
            <div class="option-row"><input type="radio" name="q_${id}_correct" value="1"><input class="o-input" placeholder="Option 2"></div>
            <div class="option-row"><input type="radio" name="q_${id}_correct" value="2"><input class="o-input" placeholder="Option 3"></div>
            <div class="option-row"><input type="radio" name="q_${id}_correct" value="3"><input class="o-input" placeholder="Option 4"></div>
        `;
        container.appendChild(div);
        creator.questions.push(div);
    },

    publish: async () => {
        const title = document.getElementById('new-title').value;
        const desc = document.getElementById('new-desc').value;
        
        if (!title) return alert("Please add a title");

        let quizId = creator.editingQuizId;

        if (quizId) {
            
            await supabase.from('quizzes').update({ title, description: desc }).eq('id', quizId);
            
            
            await supabase.from('questions').delete().eq('quiz_id', quizId);
            
        
        } else {
           
            const { data, error } = await supabase
                .from('quizzes')
                .insert([{ 
                    title, 
                    description: desc, 
                    creator_id: currentUser.id, 
                    author_name: currentUser.user_metadata.full_name 
                }])
                .select();
                
            if (error) return alert(error.message);
            quizId = data[0].id;
        }

        const questionsPayload = [];
        const blocks = document.getElementById('create-questions-area').children;
        
        for (let block of blocks) {
            const qText = block.querySelector('.q-input').value;
            const options = Array.from(block.querySelectorAll('.o-input')).map(i => i.value);
            const correctRadio = block.querySelector('input[type="radio"]:checked');
            const correctIndex = correctRadio ? parseInt(correctRadio.value) : 0;

            if(qText && options[0]) {
                questionsPayload.push({
                    quiz_id: quizId,
                    question_text: qText,
                    options: options,
                    correct_index: correctIndex 
                });
            }
        }

        const { error: qError } = await supabase.from('questions').insert(questionsPayload);
        
        if (qError) alert('Error saving questions: ' + qError.message);
        else {
            alert(creator.editingQuizId ? 'Quiz Updated!' : 'Quiz Published!');
            app.loadDashboard();
        }
    }
};    


const taker = {
    currentQuizQuestions: [],
    currentIndex: 0,
    score: 0,

    start: async (quizId, quizTitle) => {
        const { data, error } = await supabase
            .from('questions')
            .select('*')
            .eq('quiz_id', quizId);

        if (!data || data.length === 0) return alert("This quiz has no questions.");

        taker.currentQuizQuestions = data;
        taker.currentIndex = 0;
        taker.score = 0;
        
        app.toggleView('view-take');
        document.getElementById('take-title').innerText = quizTitle;
        taker.renderQuestion();
    },

    renderQuestion: () => {
        const container = document.getElementById('take-area');
        container.innerHTML = '';

        // Check if finished
        if (taker.currentIndex >= taker.currentQuizQuestions.length) {
            const percent = Math.round((taker.score / taker.currentQuizQuestions.length) * 100);
            container.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <h2>Quiz Completed!</h2>
                    <h1 style="font-size: 3rem; color: var(--primary)">${percent}%</h1>
                    <p>You scored ${taker.score} out of ${taker.currentQuizQuestions.length}</p>
                    <button onclick="app.loadDashboard()" class="btn">Back to Dashboard</button>
                </div>
            `;
            return;
        }

        const q = taker.currentQuizQuestions[taker.currentIndex];

        const qEl = document.createElement('h3');
        qEl.innerText = q.question_text;
        container.appendChild(qEl);

        // Shuffle
        let displayOptions = q.options.map((optText, index) => ({
            text: optText,
            originalIndex: index 
        }));

       
        displayOptions = shuffleArray(displayOptions);

      
        displayOptions.forEach((optObj) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = optObj.text;
       
            btn.onclick = () => taker.handleAnswer(optObj.originalIndex, q.correct_index, btn);
            container.appendChild(btn);
        });
    },

    handleAnswer: (selectedIndex, correctIndex, btn) => {
  
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.disabled = true);

        if (selectedIndex === correctIndex) {
            taker.score++;
            btn.classList.add('correct');
        } else {
            btn.classList.add('wrong');
            
            
            
        }

        setTimeout(() => {
            taker.currentIndex++;
            taker.renderQuestion();
        }, 1200); 
    }
};

        
        app.init();
    </script>
</body>
</html>
